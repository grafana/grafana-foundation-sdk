# yaml-language-server: $schema=https://raw.githubusercontent.com/grafana/cog/main/schemas/compiler_passes.json

passes:
  - cleanup_k8_resource_names: {
      prefix_to_remove: 'Dashboard'
  }
  ######################
  # Dashboard v2beta1 #
  ######################

  # To make our composability veneers shenanigans work
  - retype_field:
      field: dashboardv2beta1.VizConfigSpec.options
      as:
        kind: scalar
        scalar: { scalar_kind: any }
        nullable: true

  - retype_field:
      field: dashboardv2beta1.FieldConfig.custom
      as:
        kind: scalar
        scalar: { scalar_kind: any }
        nullable: true

  - retype_field:
      field: dashboardv2beta1.DataQueryKind.spec
      as:
        kind: scalar
        scalar: { scalar_kind: any }
        nullable: true

  - rename_object:
      from: dashboardv2beta1.Spec
      to: Dashboard

  - rename_object:
      from: dashboardv2beta1.V2beta1FieldConfigSourceOverrides
      to: FieldConfigSourceOverrides

  - rename_object:
      from: dashboardv2beta1.V2beta1RangeMapOptions
      to: RangeMapOptions

  - rename_object:
      from: dashboardv2beta1.V2beta1RegexMapOptions
      to: RegexMapOptions

  - rename_object:
      from: dashboardv2beta1.V2beta1AdhocVariableKindDatasource
      to: AdhocVariableKindDatasource

  - rename_object:
      from: dashboardv2beta1.V2beta1SpecialValueMapOptions
      to: SpecialValueMapOptions

  # Use DataSourceRef defined in common package

  - retype_field:
      field: dashboardv2beta1.AdhocVariableKind.datasource
      as: &datasource_ref
        kind: ref
        ref: { referred_pkg: common, referred_type: DataSourceRef }

  - retype_field:
      field: dashboardv2beta1.DataQueryKind.datasource
      as: *datasource_ref

  - retype_field:
      field: dashboardv2beta1.GroupByVariableKind.datasource
      as: *datasource_ref

  - omit:
      objects:
        - dashboardv2beta1.V2beta1DataQueryKindDatasource
        - dashboardv2beta1.V2beta1GroupByVariableKindDatasource
