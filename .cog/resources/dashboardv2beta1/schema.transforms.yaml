# yaml-language-server: $schema=https://raw.githubusercontent.com/grafana/cog/main/schemas/compiler_passes.json

passes:
  # Add a few useful constants
  - add_object:
      object: dashboardv2beta1.DashboardV2Beta1
      as:
        kind: scalar
        scalar: { scalar_kind: string, value: "dashboard.grafana.app/v2beta1" }

  - add_object:
      object: dashboardv2beta1.DashboardKind
      as:
        kind: scalar
        scalar: { scalar_kind: string, value: "Dashboard" }

  ######################
  # Dashboard v2beta1 #
  ######################

  # Some future-proofing
  - constant_to_enum:
      objects:
        - dashboardv2beta1.RepeatMode

  # To make our composability veneers shenanigans work
  - retype_field:
      field: dashboardv2beta1.VizConfigSpec.options
      as:
        kind: scalar
        scalar: { scalar_kind: any }
        nullable: true

  - retype_field:
      field: dashboardv2beta1.FieldConfig.custom
      as:
        kind: scalar
        scalar: { scalar_kind: any }
        nullable: true

  - retype_field:
      field: dashboardv2beta1.DataQueryKind.spec
      as:
        kind: scalar
        scalar: { scalar_kind: any }
        nullable: true

  # Is this object meant for frontend usage only?
  - omit:
      objects: [ dashboardv2beta1.VariableCustomFormatterFn ]

  - retype_field:
      field: dashboardv2beta1.CustomVariableValue.formatter
      as:
        kind: scalar
        scalar: { scalar_kind: string }
        nullable: true

  - rename_object: 
      from: dashboardv2beta1.DashboardSpec
      to: Dashboard

  #Â To get rid of the default value (each panel query needs a unique refId, and
  # an empty value as default makes it easier to identify that a unique refId
  # needs to be computed)
  - retype_field:
      field: dashboardv2beta1.PanelQuerySpec.refId
      as:
        kind: scalar
        scalar:
          scalar_kind: string

  #####################
  # FieldConfigSource #
  #####################

  # Relates to https://github.com/grafana/grafana-foundation-sdk/issues/664
  # We have to duplicate the entire definition of dashboard.FieldConfigSource
  # just to add the `__systemRef` field since overrides are defined as an
  # anonymous struct.
  - retype_object:
      object: dashboardv2beta1.FieldConfigSource
      comments:
        - The data model used in Grafana, namely the data frame, is a columnar-oriented table structure that unifies both time series and table query results.
        - Each column within this structure is called a field. A field can represent a single time series or table column.
        - Field options allow you to change how the data is displayed in your visualizations.
      as:
        kind: struct
        struct:
          fields:
            - name: defaults
              required: true
              comments:
                - Defaults are the options applied to all fields.
              type:
                kind: ref
                ref: { referred_pkg: dashboardv2beta1, referred_type: FieldConfig }
            - name: overrides
              required: true
              comments:
                - Overrides are the options applied to specific fields overriding the defaults.
              type:
                kind: array
                array:
                  value_type:
                    kind: struct
                    struct:
                      fields:
                        - name: __systemRef
                          type:
                            kind: scalar
                            scalar: { scalar_kind: string }
                        - name: matcher
                          required: true
                          type:
                            kind: ref
                            ref: { referred_pkg: dashboardv2beta1, referred_type: MatcherConfig }
                        - name: properties
                          required: true
                          type:
                            kind: array
                            array:
                              value_type:
                                kind: ref
                                ref: { referred_pkg: dashboardv2beta1, referred_type: DynamicConfigValue }
