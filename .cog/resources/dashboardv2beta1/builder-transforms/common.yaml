# yaml-language-server: $schema=https://raw.githubusercontent.com/grafana/cog/main/schemas/veneers.json

languages: [all]

package: dashboardv2beta1

builders:
  # overrides and transformations related
  - omit: { by_object: DashboardFieldConfigSourceOverrides }
  - omit: { by_object: MatcherConfig }
  - omit: { by_object: DynamicConfigValue }
  - omit: { by_object: Threshold }

  - omit: { by_object: ValueMap }
  - omit: { by_object: RangeMap }
  - omit: { by_object: RegexMap }
  - omit: { by_object: SpecialValueMap }

  - omit: { by_object: CustomVariableValue }

  ###################
  # AnnotationQuery #
  ###################

  - merge_into:
      source: AnnotationQuerySpec
      destination: AnnotationQueryKind
      under_path: spec
  - rename:
      by_object: AnnotationQueryKind
      as: AnnotationQuery

  #############################
  # ConditionalRenderingGroup #
  #############################

  - merge_into:
      source: ConditionalRenderingGroupSpec
      destination: ConditionalRenderingGroupKind
      under_path: spec
  - rename:
      by_object: ConditionalRenderingGroupKind
      as: ConditionalRenderingGroup
  
  ############################
  # ConditionalRenderingData #
  ############################

  - merge_into:
      source: ConditionalRenderingDataSpec
      destination: ConditionalRenderingDataKind
      under_path: spec
  - rename:
      by_object: ConditionalRenderingDataKind
      as: ConditionalRenderingData

  #####################################
  # ConditionalRenderingTimeRangeSize #
  #####################################

  - merge_into:
      source: ConditionalRenderingTimeRangeSizeSpec
      destination: ConditionalRenderingTimeRangeSizeKind
      under_path: spec
  - rename:
      by_object: ConditionalRenderingTimeRangeSizeKind
      as: ConditionalRenderingTimeRangeSize

  ################################
  # ConditionalRenderingVariable #
  ################################

  - merge_into:
      source: ConditionalRenderingVariableSpec
      destination: ConditionalRenderingVariableKind
      under_path: spec
  - rename:
      by_object: ConditionalRenderingVariableKind
      as: ConditionalRenderingVariable

  ####################
  # LibraryPanelKind #
  ####################

  - merge_into:
      source: LibraryPanelKindSpec
      destination: LibraryPanelKind
      under_path: spec
  - rename:
      by_object: LibraryPanelKind
      as: LibraryPanel

  # No need for builders for structs generated from a disjunction
  - omit: { generated_from_disjunction: true }

  ###########
  # Layouts #
  ###########

  ##################
  # AutoGridLayout #
  ##################

  - merge_into:
      source: AutoGridLayoutSpec
      destination: AutoGridLayoutKind
      under_path: spec
  - rename:
      by_object: AutoGridLayoutKind
      as: AutoGrid

  - merge_into:
      source: AutoGridLayoutItemSpec
      destination: AutoGridLayoutItemKind
      under_path: spec
  - rename:
      by_object: AutoGridLayoutItemKind
      as: AutoGridItem

  - merge_into:
      source: ElementReference
      destination: AutoGridItem
      under_path: spec.element

  ##############
  # RowsLayout #
  ##############

  - merge_into:
      source: RowsLayoutSpec
      destination: RowsLayoutKind
      under_path: spec
  - rename:
      by_object: RowsLayoutKind
      as: Rows

  - merge_into:
      source: RowsLayoutItemSpec
      destination: RowsLayoutItemKind
      under_path: spec
  - rename:
      by_object: RowsLayoutItemKind
      as: RowsItem

  - merge_into:
      source: ElementReference
      destination: RowsItem
      under_path: spec.element
  - promote_options_to_constructor:
      by_object: RowsItem
      options: [name]

  - merge_into:
      source: RowsLayoutRowSpec
      destination: RowsLayoutRowKind
      under_path: spec
  - rename:
      by_object: RowsLayoutRowKind
      as: Row

  ##############
  # TabsLayout #
  ##############

  - merge_into:
      source: TabsLayoutSpec
      destination: TabsLayoutKind
      under_path: spec
  - rename:
      by_object: TabsLayoutKind
      as: Tabs

  - merge_into:
      source: TabsLayoutTabSpec
      destination: TabsLayoutTabKind
      under_path: spec
  - rename:
      by_object: TabsLayoutTabKind
      as: Tab

  ##############
  # GridLayout #
  ##############

  - merge_into:
      source: GridLayoutSpec
      destination: GridLayoutKind
      under_path: spec
  - rename:
      by_object: GridLayoutKind
      as: Grid

  - merge_into:
      source: GridLayoutItemSpec
      destination: GridLayoutItemKind
      under_path: spec
  - rename:
      by_object: GridLayoutItemKind
      as: GridItem

  - merge_into:
      source: ElementReference
      destination: GridItem
      under_path: spec.element

  - merge_into:
      source: GridLayoutRowSpec
      destination: GridLayoutRowKind
      under_path: spec
  - rename:
      by_object: GridLayoutRowKind
      as: GridRow

  - omit: { by_object: GridLayoutSpec }
  - omit: { by_object: GridLayoutRowSpec }
  - omit: { by_object: GridLayoutItemSpec }

  ###########
  # Queries #
  ###########

  - merge_into:
      source: QueryGroupSpec
      destination: QueryGroupKind
      under_path: spec
  - omit: { by_object: QueryGroupSpec }
  - rename:
      by_object: QueryGroupKind
      as: QueryGroup

  - merge_into:
      source: PanelQuerySpec
      destination: PanelQueryKind
      under_path: spec
  - omit: { by_object: PanelQuerySpec }
  - rename:
      by_object: PanelQueryKind
      as: Target

  # Dataquery DataQueryKind composability
  - compose:
      by_variant: dataquery
      source_builder_name: dashboardv2beta1.DataQueryKind
      composed_builder_name: Query
      plugin_discriminator_field: group
      composition_map: # Builder → assignment root path
        __schema_entrypoint: spec
      exclude_options: [
        "spec",
      ]
      rename_options:
        datasource: old_datasource 

  - properties:
      by_name: QueryGroup
      set:
        - name: nextQueryId
          type:
            kind: scalar
            scalar: {scalar_kind: uint32}

  #######################
  # Overrides shortcuts #
  #######################

  # byName
  - add_option:
      by_object: FieldConfigSource
      option:
        name: overrideByName
        comments:
          - Adds override rules for a specific field, referred to by its name.
        arguments:
          - name: name
            type: &type_string
              kind: scalar
              scalar: {scalar_kind: string}
          - name: properties
            type: &type_DynamicConfigValue_array
              kind: array
              array: {value_type: {kind: ref, ref: {referred_pkg: dashboardv2beta1, referred_type: DynamicConfigValue}}}
        assignments:
          - method: append
            path: overrides
            value:
              envelope:
                values:
                  # Matcher
                  - field: matcher
                    value:
                      envelope:
                        values:
                          - field: id
                            value: {constant: byName}
                          - field: options
                            value: {argument: {name: name, type: *type_string}}
                  # Properties
                  - field: properties
                    value:
                      argument: { name: properties, type: *type_DynamicConfigValue_array }

  # byRegexp
  - add_option:
      by_object: FieldConfigSource
      option:
        name: overrideByRegexp
        comments:
          - Adds override rules for the fields whose name match the given regexp.
        arguments:
          - name: regexp
            type: *type_string
          - name: properties
            type: *type_DynamicConfigValue_array
        assignments:
          - method: append
            path: overrides
            value:
              envelope:
                values:
                  # Matcher
                  - field: matcher
                    value:
                      envelope:
                        values:
                          - field: id
                            value: {constant: byRegexp}
                          - field: options
                            value: {argument: {name: regexp, type: *type_string}}
                  # Properties
                  - field: properties
                    value:
                      argument: {name: properties, type: *type_DynamicConfigValue_array}

  # byType
  - add_option:
      by_object: FieldConfigSource
      option:
        name: overrideByFieldType
        comments:
          - Adds override rules for all the fields of the given type.
        arguments:
          - name: fieldType
            type: *type_string
          - name: properties
            type: *type_DynamicConfigValue_array
        assignments:
          - method: append
            path: overrides
            value:
              envelope:
                values:
                  # Matcher
                  - field: matcher
                    value:
                      envelope:
                        values:
                          - field: id
                            value: {constant: byType}
                          - field: options
                            value: {argument: {name: fieldType, type: *type_string}}
                  # Properties
                  - field: properties
                    value:
                      argument: {name: properties, type: *type_DynamicConfigValue_array}

  # byFrameRefID
  - add_option:
      by_object: FieldConfigSource
      option:
        name: overrideByQuery
        arguments:
          - name: queryRefId
            type: *type_string
          - name: properties
            type: *type_DynamicConfigValue_array
        assignments:
          - method: append
            path: overrides
            value:
              envelope:
                values:
                  # Matcher
                  - field: matcher
                    value:
                      envelope:
                        values:
                          - field: id
                            value: {constant: byFrameRefID}
                          - field: options
                            value: {argument: {name: queryRefId, type: *type_string}}
                  # Properties
                  - field: properties
                    value:
                      argument: {name: properties, type: *type_DynamicConfigValue_array}

  ###################
  # Transformations #
  ###################

  - merge_into:
      source: DataTransformerConfig
      destination: TransformationKind
      under_path: spec
  - omit: { by_object: DataTransformerConfig }
  - rename:
      by_object: TransformationKind
      as: Transformation

  ##############
  # Dashboards #
  ##############

  - rename:
      by_object: DashboardSpec
      as: Dashboard

  - rename:
      by_object: TimeSettingsSpec
      as: TimeSettings

  - promote_options_to_constructor:
      by_name: Dashboard
      options: [title]

  # Rearrange panel-related builders
  - merge_into:
      source: PanelSpec
      destination: PanelKind
      under_path: spec
  - omit: { by_object: PanelSpec }
  - rename:
      by_object: PanelKind
      as: Panel

  - merge_into:
      source: FieldConfig
      destination: VizConfigSpec
      under_path: fieldConfig.defaults
      rename_options:
        color: colorScheme
        links: dataLinks
  - merge_into:
      source: FieldConfigSource
      destination: VizConfigSpec
      under_path: fieldConfig
  - merge_into:
      source: VizConfigSpec
      destination: VizConfigKind
      under_path: spec

  # Panels VizConfigSpec composability
  - compose:
      by_variant: panelcfg
      # this should run after the "dashboard" package has done its thing
      # so these builders aren't needed anymore once the composition is done.
      preserve_original_builders: false
      source_builder_name: dashboardv2beta1.VizConfigKind
      composed_builder_name: Visualization
      plugin_discriminator_field: group
      composition_map: # Builder → assignment root path
        Options: "spec.options"
        FieldConfig: "spec.fieldConfig.defaults.custom"
      exclude_options: [
        "spec",          # merged with another builder
        "defaults",      # merged with another builder
        "fieldConfig",   # merged with another builder
        "options",       # comes from a panel plugin
        "custom",        # comes from a panel plugin
        "version",       # TODO: check if it's relevant or not
        "filterable",    # TODO: check if it's relevant or not
        "writeable",     # TODO: check if it's relevant or not
      ]

  - omit: { by_object: FieldConfig }
  - omit: { by_object: FieldConfigSource }
  - omit: { by_object: VizConfigSpec }
    
  - promote_options_to_constructor:
      by_name: DatasourceRef
      options: [ type, uid ]  

options:
  ###########
  # Layouts #
  ###########

  # GridLayoutKind + RowsLayoutKind + AutoGridLayoutKind + TabsLayoutKind
  - disjunction_as_options:
      by_builder: Dashboard.Layout
  - rename:
      by_builder: Dashboard.GridLayoutKind
      as: gridLayout
  - rename:
      by_builder: Dashboard.RowsLayoutKind
      as: rowsLayout
  - rename:
      by_builder: Dashboard.AutoGridLayoutKind
      as: autoGridLayout
  - rename:
      by_builder: Dashboard.TabsLayoutKind
      as: tabsLayout

  ##############
  # RowsLayout #
  ##############

  - omit: { by_builder: Rows.spec }
  - omit: { by_builder: RowsItem.spec }
  - omit: { by_builder: Row.spec }

  # Append a single `row` value instead of a map of everything
  - duplicate:
      by_builder: Rows.rows
      as: row
  - array_to_append:
      by_builder: Rows.row

  # GridLayoutKind + AutoGridLayoutKind + TabsLayoutKind + RowsLayoutKind
  - disjunction_as_options:
      by_builder: Row.Layout
  - rename:
      by_builder: Row.GridLayoutKind
      as: gridLayout
  - rename:
      by_builder: Row.AutoGridLayoutKind
      as: autoGridLayout
  - rename:
      by_builder: Row.TabsLayoutKind
      as: tabsLayout
  - rename:
      by_builder: Row.RowsLayoutKind
      as: rowsLayout

  ##################
  # AutoGridLayout #
  ##################

  - omit: { by_builder: AutoGrid.spec }
  - omit: { by_builder: AutoGridItem.spec }

  # Append a single `item` value instead of a map of everything
  - duplicate:
      by_builder: AutoGrid.items
      as: item
  - array_to_append:
      by_builder: AutoGrid.item

  - omit: { by_builder: AutoGridItem.element }

  ##############
  # TabsLayout #
  ##############

  - omit: { by_builder: Tabs.spec }
  - omit: { by_builder: Tab.spec }

  # Append a single `tab` value instead of a list of everything
  - duplicate:
      by_builder: Tabs.tabs
      as: tab
  - array_to_append:
      by_builder: Tabs.tab

  # GridLayoutKind + AutoGridLayoutKind + TabsLayoutKind + RowsLayoutKind
  - disjunction_as_options:
      by_builder: Tab.Layout
  - rename:
      by_builder: Tab.GridLayoutKind
      as: gridLayout
  - rename:
      by_builder: Tab.AutoGridLayoutKind
      as: AutoGridLayout
  - rename:
      by_builder: Tab.TabsLayoutKind
      as: TabsLayout
  - rename:
      by_builder: Tab.RowsLayoutKind
      as: RowsLayout

  ##############
  # GridLayout #
  ##############

  # spec options are leftovers from the merge_into veneer
  - omit: { by_builder: Grid.spec }
  - omit: { by_builder: GridItem.spec }
  - omit: { by_builder: GridRow.spec }

  - rename:
      by_builder: GridRow.elements
      as: items
  # Append a single `item` value instead of a list of everything
  - duplicate:
      by_builder: GridRow.items
      as: item
  - array_to_append:
      by_builder: GridRow.item

  # Append a single `item` value instead of a list of everything
  - duplicate:
      by_builder: Grid.items
      as: item
  - array_to_append:
      by_builder: Grid.item

  - omit: { by_builder: GridItem.element }

  # GridLayoutItemKind + GridLayoutRowKind
  - disjunction_as_options:
      by_builder: Grid.item
  - rename:
      by_builder: Grid.GridLayoutItemKind
      as: item
  - rename:
      by_builder: Grid.GridLayoutRowKind
      as: row

  ###########
  # Queries #
  ###########

  # spec options are leftovers from the merge_into veneer
  - omit: { by_builder: QueryGroup.spec }
  - omit: { by_name: PanelQueryKind.spec }

  # queries() → targets()
  - rename:
      by_name: QueryGroupKind.queries
      as: targets

  # Append a single target instead forcing to define all of them at once
  - duplicate:
      by_name: QueryGroupKind.targets
      as: target
  - array_to_append:
      by_name: QueryGroupKind.target

  # Append a single transformation instead forcing to define all of them at once
  - duplicate:
      by_name: QueryGroupKind.transformations
      as: transformation
  - array_to_append:
      by_name: QueryGroupKind.transformation

  ###################
  # Transformations #
  ###################

  # spec options are leftovers from the merge_into veneer
  - omit: { by_builder: Transformation.spec }

  ##########
  # Panels #
  ##########

  # spec options are leftovers from the merge_into veneer
  - omit: { by_name: PanelKind.spec }

  # VizConfig() → Visualization()
  - rename:
      by_name: PanelKind.VizConfig
      as: visualization

  ##############
  # Dashboards #
  ##############

  # Append a single `element` value instead of a map of everything
  - duplicate:
      by_builder: Dashboard.Elements
      as: element
  - map_to_index:
      by_builder: Dashboard.element
  # panel + library panel
  - disjunction_as_options:
      by_builder: Dashboard.element
      argument_index: 1
  - rename:
      by_builder: Dashboard.PanelKind
      as: panel
  - rename:
      by_builder: Dashboard.LibraryPanelKind
      as: libraryPanel

  # Append a single override instead forcing to define all of them at once
  - duplicate:
      by_name: VizConfigKind.overrides
      as: override
  - array_to_append:
      by_name: VizConfigKind.override

  # Append a single variable instead forcing to define all of them at once
  - duplicate:
      by_builder: Dashboard.variables
      as: variable
  - array_to_append:
      by_builder: Dashboard.variable
