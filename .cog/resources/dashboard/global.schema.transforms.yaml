# yaml-language-server: $schema=https://raw.githubusercontent.com/grafana/cog/main/schemas/compiler_passes.json

passes:
  # Ensure consistent DataSourceRef
  - replace_reference:
      from: dashboard.DataSourceRef
      to: common.DataSourceRef

  - retype_object:
      object: dashboard.DataSourceRef
      as:
        kind: ref
        ref: { referred_pkg: common, referred_type: DataSourceRef }

  # In the original `librarypanel.PanelModel` schema, the "model" field is left
  # mainly undefined but a comment indicates that it should be the same panel
  # schema defined in dashboard with a few fields omitted:
  #   model: Omit<dashboard.Panel, 'gridPos' | 'id' | 'libraryPanel'>
  - duplicate_object:
      object: dashboard.Panel
      as: librarypanel.PanelModel
      omit_fields:
        - id
        - gridPos
        - libraryPanel
  - retype_field:
      field: librarypanel.LibraryPanel.model
      as:
        kind: ref
        ref: { referred_pkg: librarypanel, referred_type: PanelModel }
