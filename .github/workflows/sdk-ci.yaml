name: SDK CI
on:
  pull_request: ~

env:
  DEVBOX_VERSION: '0.16.0'
  FOUNDATION_SDK_REPO: https://github.com/grafana/grafana-foundation-sdk.git

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  run_codegen:
    name: Run codegen pipeline
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Get secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@c2f1df59dba624b3fd509e5181aa8da5217120c0
        with:
          repo_secrets: |
            SCHEMA_READER_APP_ID=schema_reader:app-id
            SCHEMA_READER_PRIVATE_KEY=schema_reader:private-key

      - name: Generate github private token
        id: generate_reader_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ env.SCHEMA_READER_APP_ID }}
          private-key: ${{ env.SCHEMA_READER_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Setup cog
        uses: ./.github/actions/setup-cog

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 #v0.14.0
        with:
          enable-cache: 'true'
          devbox-version: ${{ env.DEVBOX_VERSION }}

      - name: Run codegen pipeline
        run: |
          git config --global user.email "cog-ci@grafana.com"
          git config --global user.name "cog - CI"

          devbox run ./scripts/prepare-release.sh
        env:
          TERM: 'xterm'
          WORKSPACE_PATH: /tmp/foundation-workspace-current
          CLEANUP_WORKSPACE: 'no'
          SKIP_VALIDATION: 'no'
          LOG_LEVEL: '7' # debug
          GOGC: 'off'
          GITHUB_AUTH_TOKEN: ${{ steps.generate_reader_token.outputs.token }}

  run_examples:
    name: Run examples
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Get secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@c2f1df59dba624b3fd509e5181aa8da5217120c0
        with:
          repo_secrets: |
            SCHEMA_READER_APP_ID=schema_reader:app-id
            SCHEMA_READER_PRIVATE_KEY=schema_reader:private-key

      - name: Generate github private token
        id: generate_reader_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ env.SCHEMA_READER_APP_ID }}
          private-key: ${{ env.SCHEMA_READER_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 #v0.14.0
        with:
          enable-cache: 'true'
          devbox-version: ${{ env.DEVBOX_VERSION }}

      - name: Run codegen pipeline
        run: |
          devbox run make generate
        env:
          GOGC: 'off'
          GITHUB_AUTH_TOKEN: ${{ steps.generate_reader_token.outputs.token }}

      - name: Run examples
        run: |
          devbox run ./scripts/run-examples.sh

  diff_preview:
    name: Generate diff
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      id-token: write

    if: github.ref != 'refs/heads/release-preview'

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Setup cog
        uses: ./.github/actions/setup-cog

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 #v0.14.0
        with:
          enable-cache: 'true'
          devbox-version: ${{ env.DEVBOX_VERSION }}

      - name: Get secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@c2f1df59dba624b3fd509e5181aa8da5217120c0
        with:
          repo_secrets: |
            SCHEMA_READER_APP_ID=schema_reader:app-id
            SCHEMA_READER_PRIVATE_KEY=schema_reader:private-key

      - name: Generate github private token
        id: generate_reader_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ env.SCHEMA_READER_APP_ID }}
          private-key: ${{ env.SCHEMA_READER_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Dry-run release with current branch
        run: |
          git config --global user.email "cog-ci@grafana.com"
          git config --global user.name "cog - CI"

          devbox run ./scripts/prepare-release.sh
        env:
          TERM: 'xterm'
          WORKSPACE_PATH: /tmp/foundation-workspace-current
          CLEANUP_WORKSPACE: 'no'
          SKIP_VALIDATION: 'yes'
          LOG_LEVEL: '7' # debug
          GOGC: 'off'
          GITHUB_AUTH_TOKEN: ${{ steps.generate_reader_token.outputs.token }}

      - name: Identify latest branch
        id: latest_branch
        run: |
          echo "ref=$(./scripts/release-preview-or-main.sh)" >> $GITHUB_OUTPUT

      - name: Checkout main branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ steps.latest_branch.outputs.ref }}
          persist-credentials: false

      - name: Preview diff
        run: |
          cat <<'EOF' > preview.md
          <!-- grafana-foundation-sdk-diff-preview-marker -->
          
          **Note:** the diff show code changes that would be introduced by this PR. Changes already on `main` are excluded.
          
          <details>
          <summary>
          
          ### ðŸ”Ž Changes to `main`
          
          </summary>
          
          ```patch
          EOF
          
          diff \
            --new-file \
            --unidirectional-new-file \
            --color=never \
            --unified \
            --recursive \
            --exclude='.git' \
            --exclude='.cog' \
            --exclude='typescript/dist' \
            --exclude='scripts*' \
            --exclude='gradle.properties' \
            --exclude='pyproject.toml' \
            --exclude='package.json' \
            --exclude='yarn.lock' \
            --exclude='*.md' \
            ./ /tmp/foundation-workspace-current/foundation-sdk/ >> preview.md || true # diff returns 1 if the two targets have differences
          
          cat <<'EOF' >> preview.md
          ```
          </details>
          EOF

      - name: Find preview comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad  # v4.0.0
        id: preview-comment-find
        if: "!contains(github.actor, 'dependabot') && github.repository == 'grafana/grafana-foundation-sdk'" # only run on main repo, and not on dependabot PRs
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'grafana-foundation-sdk-diff-preview-marker'

      - name: Upsert preview comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        if: "!contains(github.actor, 'dependabot') && github.repository == 'grafana/grafana-foundation-sdk'" # only run on main repo, and not on dependabot PRs
        with:
          comment-id: ${{ steps.preview-comment-find.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: './preview.md'
